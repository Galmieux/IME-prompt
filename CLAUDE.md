# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクトの目的

このリポジトリは、Prompt Line アプリケーションの日本語IME（Input Method Editor）対応を改善するためのフォークプロジェクトです。

### 主な目標
- **日本語IME互換性の向上**: 日本語入力時の動作を最適化し、より自然な日本語入力体験を提供
- **日本語ワークフローへの対応**: 日本語での開発・執筆作業に特化した機能の追加
- **日本語開発ツールとの連携**: 日本語環境で使用される各種エディタやツールとの統合改善
- **Claude Code風のコマンド機能**: `/コマンド` と `@メンション` による高度な入力支援機能の実装

## リポジトリ構造

```
IME-prompt/
├── .git/                 # Gitリポジトリデータ
├── forked-repo/         # オリジナルのPrompt Lineコードベース（nkmr-jp/prompt-lineからフォーク）
│   ├── src/            # ソースコード
│   ├── native/         # ネイティブSwiftツール
│   ├── tests/          # テストファイル
│   ├── build/          # ビルド設定
│   ├── assets/         # アプリケーションアセット
│   ├── CLAUDE.md       # Prompt Line本体の開発ガイド（英語）
│   └── ...             # その他のプロジェクトファイル
└── CLAUDE.md           # このファイル（プロジェクト全体の日本語ガイド）
```

## forked-repoディレクトリとの関係

### ディレクトリの役割
- **ルートディレクトリ (IME-prompt/)**: フォークプロジェクト全体の管理、IME対応機能の追加開発
- **forked-repo/**: オリジナルのPrompt Lineアプリケーション本体

### 開発時の注意点
1. **Prompt Line本体の変更**: `forked-repo/` 内で作業し、`forked-repo/CLAUDE.md` の指示に従う
2. **IME対応機能の追加**: 必要に応じてルートディレクトリに新しいコンポーネントを追加
3. **ドキュメントの使い分け**:
   - このファイル（ルートのCLAUDE.md）: フォーク固有の情報、日本語IME対応に関する指示
   - `forked-repo/CLAUDE.md`: Prompt Line本体の開発ガイドライン（詳細な技術仕様）

## 開発ワークフロー

### 初期セットアップ
```bash
cd forked-repo
npm install
npm start
```

### よく使うコマンド
```bash
# 開発
cd forked-repo
npm start                    # 開発モードでアプリを起動

# テスト
cd forked-repo
npm test                     # 全テストを実行
npm run test:watch          # ウォッチモードでテストを実行

# ビルド
cd forked-repo
npm run build               # アプリケーションをビルド
npm run compile             # 完全なコンパイル（TypeScript + Renderer + ネイティブツール）
```

## 特定の指示と注意事項

### 日本語IME対応に関する重要事項
1. **文字入力の扱い**:
   - 日本語入力中の確定前文字列（変換中テキスト）の処理に注意
   - IME確定イベントとキーボードイベントのタイミングを考慮

2. **ショートカットキーの競合**:
   - 日本語IMEのショートカットとアプリのショートカットが競合しないよう配慮
   - 特にCmd/Ctrl+Enterなどの重要なキーバインドに注意

3. **テキストフィールド検出**:
   - 日本語入力が有効なテキストフィールドを正確に検出
   - macOSのAccessibility APIを使用した日本語入力状態の把握

### コマンド機能の実装要件

#### 既存機能の拡張
Prompt Lineには既に以下の機能が実装されています：
- **スラッシュコマンド (`/`)**: マークダウンファイルベースのカスタムコマンドシステム
- **ファイル検索 (`@`)**: ファイルパスの補完とファジーマッチング機能
- **エージェント選択**: 利用可能なエージェントの選択機能

#### 追加実装が必要な機能

1. **`/` スラッシュコマンドの改善**:
   - Claude Code風のコマンドパレットUI
   - コマンドの説明・プレビュー表示
   - 日本語IME入力中でもコマンド候補を表示
   - キーボードナビゲーション（↑↓キーで選択、Enterで実行）
   - コマンドの履歴・頻度による優先順位付け

2. **`@` メンション機能の強化**:
   - ファイルパス以外のメンション対象の追加：
     - `@file`: ファイルパス（既存機能）
     - `@code`: コードスニペット参照
     - `@doc`: ドキュメント参照
     - `@history`: 履歴からの引用
   - メンションのプレビュー機能
   - 複数メンションの管理

3. **日本語IMEとの統合**:
   - 日本語入力中でも `/` や `@` をトリガーとして認識
   - 全角文字 `／` `＠` も半角と同様に扱う
   - 変換確定前でもコマンド候補を表示
   - IME確定後にコマンド実行

4. **UI/UX改善**:
   - コマンド候補のポップアップ表示
   - 候補リストのフィルタリング（インクリメンタルサーチ）
   - ハイライト表示とシンタックスカラーリング
   - ダークモード対応

#### 実装の優先順位
1. **Phase 1**: 日本語IMEでの `/` `@` 認識改善（全角対応）
2. **Phase 2**: コマンドパレットUIの改善
3. **Phase 3**: メンション機能の拡張（@code, @doc, @history）
4. **Phase 4**: プレビュー機能とUIポリッシュ

#### 技術的考慮事項
- 既存の `SlashCommandManager` と `FileSearchManager` を拡張
- `forked-repo/src/renderer/` 内のマネージャークラスに機能追加
- `forked-repo/src/handlers/mdsearch-handler.ts` でのバックエンド処理
- テストケースの追加（`forked-repo/tests/`）

### コミットメッセージ
Angularコミットメッセージ規約に従ってください：

```
<type>(<scope>): <subject>

例：
feat(ime): 日本語入力時のカーソル位置検出を改善
fix(input): IME確定時の二重入力を修正
docs(readme): 日本語IME対応について説明を追加
```

### 上流リポジトリとの同期
オリジナルリポジトリ: https://github.com/nkmr-jp/prompt-line

上流の変更を取り込む場合：
```bash
cd forked-repo
git remote add upstream https://github.com/nkmr-jp/prompt-line.git
git fetch upstream
git merge upstream/main
```

### セキュリティに関する注意
- forked-repo内のセキュリティガイドラインに従う
- 日本語入力データの取り扱いに注意（個人情報保護）
- ネイティブツールとの連携時のサニタイゼーション

## 詳細な技術情報

Prompt Line本体の詳細な技術情報、アーキテクチャ、ビルドプロセス、トラブルシューティングについては、`forked-repo/CLAUDE.md` を参照してください。
